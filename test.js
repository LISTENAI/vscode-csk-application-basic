
const nodes = [{"name":"AUDIOPLL_GetAudioFreq","identifier":"","address":"18004050","size":36,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":323,"type":"function"},{"name":"AUDIOPLL_GetCoreFreq","identifier":"","address":"18004020","size":48,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":319,"type":"function"},{"name":"AUDIOPLL_GetFlashFreq","identifier":"","address":"18003ffc","size":36,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":316,"type":"function"},{"name":"AUDIOPLL_GetPLLFreq","identifier":"","address":"18000c98","size":168,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":308,"type":"function"},{"name":"AUDIOPLL_GetPsramFreq","identifier":"","address":"18003fd8","size":36,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":313,"type":"function"},{"name":"BootClock_Init","identifier":"","address":"180027f0","size":664,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/clock_config.c","line":11,"type":"function"},{"name":"CP_Vector_Table","identifier":"","address":"00080554","size":128,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/venus_ap.c","line":252,"type":"variable"},{"name":"CRM_CLK_AON_32KHZ","identifier":"","address":"18005ff4","size":18,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":332,"type":"function"},{"name":"CRM_CLK_CMN_32KHZ","identifier":"","address":"18005fe2","size":18,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":329,"type":"function"},{"name":"CRM_CLK_XTAL_24MHZ","identifier":"","address":"18004074","size":20,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":326,"type":"function"},{"name":"CRM_GetApFreq","identifier":"","address":"180075fe","size":28,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":1662,"type":"function"},{"name":"CRM_GetApahbFreq","identifier":"","address":"1800761a","size":14,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":1677,"type":"function"},{"name":"CRM_GetApapbFreq","identifier":"","address":"1800774c","size":44,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":1733,"type":"function"},{"name":"CRM_GetAprootFreq","identifier":"","address":"180075d2","size":44,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":1649,"type":"function"},{"name":"CRM_GetPsramFreq","identifier":"","address":"180071aa","size":56,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":1420,"type":"function"},{"name":"CRM_GetRootFreq","identifier":"","address":"1800735a","size":48,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":1494,"type":"function"},{"name":"CRM_GetSrcFreq","identifier":"","address":"18004088","size":342,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":335,"type":"function"},{"name":"CRM_GetUart0Freq","identifier":"","address":"18006168","size":62,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":431,"type":"function"},{"name":"CRM_GetUart1Freq","identifier":"","address":"18006308","size":62,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":501,"type":"function"},{"name":"CRM_GetUart2Freq","identifier":"","address":"180064a8","size":62,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/ClockManager.c","line":571,"type":"function"},{"name":"Default_Handler","identifier":"","address":"1800584e","size":14,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/venus_ap.c","line":16,"type":"function"},{"name":"GINT_enabled","identifier":"","address":"18005890","size":40,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/include/hal/venus_ap.h","line":316,"type":"function"},{"name":"HAL_CP_Interrupt_Enable","identifier":"","address":"1800585c","size":52,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/modules/hal/listenai/csk6/drivers/cm33/venus_ap.c","line":304,"type":"function"},{"name":"z_device_state_init","identifier":"","address":"18007882","size":2,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/device.c","line":34,"type":"function"},{"name":"z_do_kernel_oops","identifier":"","address":"18005646","size":8,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/arch/arm/core/aarch32/fatal.c","line":81,"type":"function"},{"name":"z_fatal_error","identifier":"","address":"180078b0","size":56,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/fatal.c","line":94,"type":"function"},{"name":"z_idle_stacks","identifier":"","address":"00081688","size":320,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/init.c","line":51,"type":"variable"},{"name":"z_idle_threads","identifier":"","address":"00080280","size":192,"line":null,"type":"variable"},{"name":"z_impl_k_thread_abort","identifier":"","address":"18001ff4","size":36,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/arch/arm/core/aarch32/cortex_m/thread_abort.c","line":27,"type":"function"},{"name":"z_impl_z_current_get","identifier":"","address":"18004f5c","size":12,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":1368,"type":"function"},{"name":"z_init_static_threads","identifier":"","address":"18004bcc","size":152,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/thread.c","line":723,"type":"function"},{"name":"z_interrupt_stacks","identifier":"","address":"000817c8","size":2048,"line":null,"type":"variable"},{"name":"z_irq_spurious","identifier":"","address":"1800564e","size":8,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/arch/arm/core/aarch32/irq_manage.c","line":154,"type":"function"},{"name":"z_main_stack","identifier":"","address":"00080e88","size":2048,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/init.c","line":44,"type":"variable"},{"name":"z_main_thread","identifier":"","address":"00080340","size":192,"line":null,"type":"variable"},{"name":"z_priq_dumb_best","identifier":"","address":"18007950","size":12,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":954,"type":"function"},{"name":"z_ready_thread","identifier":"","address":"1800795c","size":32,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":504,"type":"function"},{"name":"z_reschedule","identifier":"","address":"18004ce0","size":36,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":823,"type":"function"},{"name":"z_reschedule_irqlock","identifier":"","address":"18007924","size":24,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":832,"type":"function"},{"name":"z_reschedule_unlocked","identifier":"","address":"1800793c","size":20,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/include/ksched.h","line":73,"type":"function"},{"name":"z_reset_time_slice","identifier":"","address":"18004c64","size":44,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":348,"type":"function"},{"name":"z_sched_init","identifier":"","address":"18004f44","size":24,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":1084,"type":"function"},{"name":"z_sched_start","identifier":"","address":"18004ed0","size":60,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":520,"type":"function"},{"name":"z_set_timeout_expiry","identifier":"","address":"180079ec","size":54,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/timeout.c","line":209,"type":"function"},{"name":"z_setup_new_thread","identifier":"","address":"18004b6c","size":96,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/thread.c","line":509,"type":"function"},{"name":"z_sys_init_run_level","identifier":"","address":"180049b4","size":64,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/device.c","line":55,"type":"function"},{"name":"z_sys_post_kernel","identifier":"","address":"00080e82","size":1,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/init.c","line":156,"type":"variable"},{"name":"z_thread_abort","identifier":"","address":"18004f68","size":164,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":1502,"type":"function"},{"name":"z_thread_entry","identifier":"","address":"18005338","size":20,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/lib/os/thread_entry.c","line":30,"type":"function"},{"name":"z_thread_timeout","identifier":"","address":"1800797c","size":68,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":666,"type":"function"},{"name":"z_time_slice","identifier":"","address":"18004de0","size":132,"file":"/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/zephyr/kernel/sched.c","line":385,"type":"function"}];

// console.log(nodes);

console.log(JSON.stringify(generateTree(nodes)));
// generateTree(nodes);

function generateTree(nodes) {
  const treeDTO = [];

  if (!nodes) {
    return;
  }
  const tree = {
    name: 'ROOT',
    size: 0,
    identifier: 'root',
    children: []
  };
  
  nodes.forEach(node => {
    // const filepath = node?.file?.replace('/Users/zhaozhuobin/ifly/scanpen_csk6/.sdk/', '');
    
    const sepPath = node?.file?.split('/');
    let children = treeDTO;

    if (sepPath) {
      sepPath.push(node.name);
      sepPath.forEach((key, index) => {
        if (key) {
          let treeNode = {
            name: key,
            identifier: key,
            size: node.size || 0
          };
          if (!children) {
            children = [treeNode];
            // children.push(treeNode);
          }
          let isExist = false;
          for (const i in children) {
            const item = children[i];
            if (item.identifier === treeNode.identifier) {
              // if (!item.children) {
              //   // item.children = [];
              // }
              item.size += treeNode.size;
              children = item.children;
              isExist = true;
              break;
            }
          }
          
          if (!isExist) {
            if (index === sepPath.length - 2) {
              treeNode.file = node.file;
              treeNode.type = 'file';
            }
            if (index === sepPath.length - 1) {
              treeNode = Object.assign(treeNode, {
                name: node.name,
                address: node.address,
                file: node.file,
                line: node.line,
                type: node.type
              });
            }
            children.push(treeNode);
            if (index !== sepPath.length - 1) {
              if (!children[children.length - 1].children) {
                children[children.length - 1].children = [];
              }
              children = children[children.length - 1].children || [];
            }
          }
        }
        
      });
    }
  });
  tree.children = treeDTO;
  tree.size = treeDTO.reduce(
    (a, b) => a.size || 0 + b.size || 0,
    0
  );
  return tree;
}